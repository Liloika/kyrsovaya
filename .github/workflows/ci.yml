name: Kubernetes Security Scan

on:
  push:
    branches: [ "main" ]

jobs:

  scan-violate:
    name: Scan violate manifest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Run kube-score (violate)
        id: violate-scan
        run: |
          mkdir -p report

          # –ó–∞–ø—É—Å–∫–∞–µ–º kube-score, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥,
          # job —Ä–µ–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫
          docker run --rm \
            -v ${{ github.workspace }}:/workdir \
            zegl/kube-score:latest \
            score /workdir/k8s/deploy-false/deployment.yml \
            --output-format json > report/false.json || true

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏
          ERR_COUNT=$(jq '.[] | .checks[] | select(.grade < 5) | length' report/false.json | wc -l)
          if [ "$ERR_COUNT" -gt 0 ]; then
            echo "::error ::Scan violate manifest –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏ ($ERR_COUNT)"
            echo "Scan violate manifest: ‚ùå –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏" >> $GITHUB_STEP_SUMMARY
          else
            echo "::notice ::Scan violate manifest –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            echo "Scan violate manifest: ‚úÖ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload violate result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: violate-result
          path: report/false.json

  scan-nonviolate:
    name: Scan non-violate manifest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Run kube-score (secure)
        id: nonviolate-scan
        run: |
          mkdir -p report

          docker run --rm \
            -v ${{ github.workspace }}:/workdir \
            zegl/kube-score:latest \
            score /workdir/k8s/deploy-true/deployment.yml \
            --output-format json > report/true.json || true

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
          ERR_COUNT=$(jq '.[] | .checks[] | select(.grade < 5) | length' report/true.json | wc -l)
          if [ "$ERR_COUNT" -gt 0 ]; then
            echo "::error ::Scan non-violate manifest –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏ ($ERR_COUNT)"
            echo "Scan non-violate manifest: ‚ùå –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏" >> $GITHUB_STEP_SUMMARY
          else
            echo "::notice ::Scan non-violate manifest –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            echo "Scan non-violate manifest: ‚úÖ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload non-violate result
        uses: actions/upload-artifact@v4
        with:
          name: nonviolate-result
          path: report/true.json

  prepare-report:
    name: Prepare HTML report
    runs-on: ubuntu-latest
    needs:
      - scan-violate
      - scan-nonviolate
    if: always()
    steps:
      - uses: actions/checkout@v5

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Generate HTML report
        run: |
          mkdir -p report

          cat << 'EOF' > report/index.html
          <!DOCTYPE html>
          <html lang="ru">
          <head>
          <meta charset="UTF-8">
          <title>Kubernetes Security Scan Report</title>
          <style>
          body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 20px;
          }
          h1 {
            color: #2c3e50;
          }
          .file {
            background: #ffffff;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
          }
          details {
            margin-top: 10px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
          }
          summary {
            font-weight: bold;
            cursor: pointer;
          }
          .ok {
            color: #2ecc71;
          }
          .error {
            color: #e74c3c;
          }
          .skipped {
            color: #f39c12;
          }
          .comment {
            background: #fefefe;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
          }
          .meta {
            color: #7f8c8d;
            font-size: 14px;
          }
          </style>
          </head>
          <body>

          <h1>üìã Kubernetes Security Scan Report</h1>

          <!-- –ü–ª–æ—Ö–æ–π —Ñ–∞–π–ª -->
          <div class="file">
            <p class="meta"><b>–§–∞–π–ª:</b> /workdir/k8s/deploy-false/deployment.yml</p>
            <p class="meta"><b>–û–±—ä–µ–∫—Ç:</b> Deployment / vulnerable-app</p>

            <details open>
              <summary>‚ùå –û—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</summary>
              <div class="comment error">
                <b>Container Image Tag</b><br>
                –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä <code>app</code> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–≥ <code>latest</code><br>
                <i>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–≥ –æ–±—Ä–∞–∑–∞</i>
              </div>
              <div class="comment error">
                <b>ReadOnlyRootFilesystem</b><br>
                Root filesystem –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏<br>
                <i>securityContext.readOnlyRootFilesystem = true</i>
              </div>
              <div class="comment error">
                <b>Privileged Container</b><br>
                –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤ privileged-—Ä–µ–∂–∏–º–µ<br>
                <i>securityContext.privileged = false</i>
              </div>
              <div class="comment error">
                <b>Resources</b><br>
                –ù–µ –∑–∞–¥–∞–Ω—ã requests/limits –¥–ª—è CPU –∏ Memory
              </div>
              <div class="comment error">
                <b>User / Group ID</b><br>
                –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å UID/GID &lt; 10000
              </div>
              <div class="comment error">
                <b>Ephemeral Storage</b><br>
                –ù–µ –∑–∞–¥–∞–Ω—ã requests –∏ limits
              </div>
              <div class="comment error">
                <b>NetworkPolicy</b><br>
                Pod –Ω–µ –ø–æ–∫—Ä—ã—Ç NetworkPolicy
              </div>
            </details>

            <details>
              <summary>‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (skipped)</summary>
              <p class="skipped">Container Seccomp Profile ‚Äî optional</p>
              <p class="skipped">CPU requests equal limits ‚Äî ignored</p>
              <p class="skipped">Memory requests equal limits ‚Äî ignored</p>
              <p class="skipped">Deployment replicas &lt; 2</p>
            </details>

            <details>
              <summary>‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</summary>
              <p class="ok">Stable API version</p>
              <p class="ok">Label values</p>
              <p class="ok">ImagePullPolicy</p>
              <p class="ok">Deployment selector labels</p>
            </details>
          </div>

          <!-- –•–æ—Ä–æ—à–∏–π —Ñ–∞–π–ª -->
          <div class="file">
            <p class="meta"><b>–§–∞–π–ª:</b> /workdir/k8s/deploy-true/deployment.yml</p>
            <p class="meta"><b>–û–±—ä–µ–∫—Ç:</b> Deployment / secure-app</p>

            <details open>
              <summary>‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</summary>
              <p class="ok">Stable API version</p>
              <p class="ok">Label values</p>
              <p class="ok">ImagePullPolicy</p>
              <p class="ok">Deployment selector labels</p>
              <p class="ok">Container Security Context</p>
              <p class="ok">Resources Requests & Limits</p>
              <p class="ok">NetworkPolicy</p>
            </details>
          </div>

          </body>
          </html>
          EOF

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: kube-security-report
          path: report
